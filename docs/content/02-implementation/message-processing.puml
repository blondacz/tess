@startuml
participant Client
participant EventSourcedSystem 
participant MessageHandler
participant Coordinator
participant ActorFactory
participant Actor
participant EventStore
participant Disp

Client ->> EventSourcedSystem: process(msg)
EventSourcedSystem ->> Coordinator: start() -> startRank
EventSourcedSystem ->> MessageHandler: handle(msg)
MessageHandler ->> ActorFactory: route(msg)
ActorFactory -->> MessageHandler: actorIds
loop per actorId
  MessageHandler ->> Coordinator: load(actorKey)
  alt existing actor
    Coordinator ->> EventStore: load(actorKey)
    EventStore -->> Coordinator: uows
    Coordinator -->> MessageHandler: actor, version
  else new actor
    ActorFactory ->> ActorFactory: receive(msg) -> initEvent
    ActorFactory ->> Actor: create(initEvent)
  end
  Actor ->> Actor: receive(msg) -> events
  Actor ->> Actor: update(events)
  MessageHandler ->> Coordinator: store(uow, actor)
  Coordinator ->> Disp: dispatch(uow)
end
alt success
  EventSourcedSystem ->> Coordinator: commit()
  Coordinator ->> EventStore: store(uowâ€¦)
  Coordinator ->> Disp: commit(lastRank)
  Coordinator -->> EventSourcedSystem: lastRank
else failure
  EventSourcedSystem ->> Coordinator: rollback()
  Coordinator ->> Disp: rollback()
end
EventSourcedSystem -->> Client: replayed UOWs
@enduml
