@startuml
title Direct Command Reaction Flow

participant ActorA
participant MessageHandler
participant Coordinator
participant ActorFactory as ActorFactory
participant ActorB 
participant EventStore
participant Disp

== Command emission ==
ActorA -> ActorA: receive(msg) -> reactions
note right: reactions include CommandMessage(targetIds)
ActorA -> MessageHandler: CommandMessage

== Routing and delivery ==
MessageHandler -> Coordinator: load(targetKey)
alt existing target
  Coordinator -> EventStore: load(targetKey)
  EventStore -->> Coordinator: uows
  Coordinator -->> MessageHandler: target, version
else new target
  ActorFactory -> ActorFactory: receive(cmd) -> initEvent
  ActorFactory -> ActorB: create(initEvent)
end
ActorB -> ActorB: receive(CommandMessage) -> reactions
ActorB -> ActorB: update(events only)

== Persistence & dispatch ==
MessageHandler -> Coordinator: EventStore(ActorUnitOfWork(reactions), target)
Coordinator -> Disp: dispatch(uow)  # keeps command order with events/notifications
...
Coordinator -> EventStore: EventStore(uowâ€¦) on commit

== Replay ==
loop replay
  Disp -> ActorB: headMessage (CommandMessage) in sequence
  ActorB -> ActorB: receive(CommandMessage)
end
@enduml
