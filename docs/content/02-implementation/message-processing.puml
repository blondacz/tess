@startuml
participant Client
participant Tess as EventSourcedSystem 
participant Handler as MessageHandler
participant Coord as Coordinator
participant Factory as ActorFactory
participant Actor
participant Store as EventStore
participant Disp as Dispatcher

== Kickoff ==
Client ->> Tess: process(initial Message)
Tess ->> Coord: start() -> startRank
Tess ->> Handler: handle(Message)

== Produce reactions per actor ==
Handler ->> Factory: route(msg)
Factory -->> Handler: actorIds
loop per actorId
  Handler ->> Coord: load(actorKey)
  alt existing actor
    Coord ->> Store: load(actorKey)
    Store -->> Coord: uows
    Coord -->> Handler: actor, version
  else new actor
    Factory ->> Factory: receive(msg) -> initEvent
    Factory ->> Actor: create(initEvent)
  end
  Actor ->> Actor: receive(msg) -> reactions (Event | Command | Notification)
  Actor ->> Actor: update(events only)
  Handler ->> Coord: store(ActorUnitOfWork(reactions), actor)
  Coord ->> Disp: dispatch(uow)  # in-order delivery (events, commands, notifications)
end

== Commit or rollback ==
alt success
  Tess ->> Coord: commit()
  Coord ->> Store: store(uowâ€¦)
  Coord ->> Disp: commit(lastRank)
  Coord -->> Tess: lastRank
else failure
  Tess ->> Coord: rollback()
  Coord ->> Disp: rollback()
end

== Replay ==
Tess -->> Client: replayed UOWs (reactions preserved in sequence)
@enduml
